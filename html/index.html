<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <button id="login">Login</button>
    <button id="logout" style="display: none;">Logout</button>
    <p id="email"></p>


    <script src="./assets/fusionauth-typescript-client.min.js"></script>
    <script>
        // const url = 'http://localhost:3000/dev/oauth/authorize?response_type=code&client_id=94ced9a2-e7b1-4270-822e-38db700613f3&redirect_uri=http://localhost:3000/dev/oauth/callback'; // ini buat proxy itu
        const client = new FusionAuth.FusionAuthClient('JmFYsbb_-OBmkEkEtwgcLRTxzjb9yqrEi1pPJLzOWhCL1DjPtnPhJajX', 'http://54.169.12.184:9011');

        document.querySelector('#login').addEventListener('click', function (e) {
            window.location = 'http://54.169.12.184:9011/oauth2/authorize?response_type=code&client_id=94ced9a2-e7b1-4270-822e-38db700613f3&redirect_uri=https://h32j8qyszc.execute-api.ap-southeast-1.amazonaws.com/dev/oauth/callback'
            // fetch(url).then(res => res.json()).then(data => window.location = data.url)
        })

        document.querySelector('#logout').addEventListener('click', function (e) {
            sessionStorage.removeItem("token");
            window.location = 'http://54.169.12.184:9011/oauth2/logout?client_id=94ced9a2-e7b1-4270-822e-38db700613f3';
        })

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        let token = params?.token;

        if (token) sessionStorage.setItem("token", token);

        const theToken = sessionStorage.getItem("token");

        const getUser = async (client_id, token) => {
            try {
                const introspect = await client.introspectAccessToken(client_id, token);
                const register = await client.retrieveRegistration(introspect.response.sub, '94ced9a2-e7b1-4270-822e-38db700613f3')

                return {
                    introspect, register
                }
            } catch (error) {
                console.error(error);
            }
        }

        if (theToken) {
            document.querySelector('#login').style.display = "none";
            document.querySelector('#logout').style.display = "block";
            const user = getUser('94ced9a2-e7b1-4270-822e-38db700613f3', theToken).then(res => {
                document.querySelector('#email').textContent = res.introspect.response.email
                console.log(res);
            })
        }


    </script>

</body>

</html>